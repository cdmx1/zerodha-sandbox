<!DOCTYPE html>
<html lang="en">
<head>
  <title>Zerodha APIs Test environment by nordible</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
</head>
<body>
<div class="jumbotron text-center">
  <h2>Zerodha APIs Test environment</h2>
  <p>Free sandbox for testing Zerodha's <a href="https://kite.trade/docs/connect/v3">Kite and Coin APIs</a></p> 
  APIs are mocked at this root URL <code>https://zerodha-sandbox.herokuapp.com/</code>
</div>
<style>
  .instrument-field {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }
  .instrument-field input {
    flex: 1;
    margin-right: 5px;
  }
</style>
<div class="container mt-4">
  <form id="instrumentForm">
    <div id="instrumentFields">
      <div class="form-row mb-2 instrument-field">
        <input type="number" class="form-control" placeholder="Instrument Token" name="instrument_token[]" required>
        <input type="number" class="form-control" placeholder="Min Price" name="min_price[]" required>
        <input type="number" class="form-control" placeholder="Max Price" name="max_price[]" required>
      </div>
    </div>

    <button type="button" class="btn btn-primary mb-2" id="addInstrument">Add Instrument</button>
    <button type="submit" class="btn btn-success mb-2" id="startWebhook">Start Webhook</button>
    <button type="button" class="btn btn-danger mb-2" id="stopWebhook" style="display: none;">Stop Webhook</button>
  </form>

  <div id="responseMessage" style="display: none;"></div>
</div>
  <footer>&copy; <a href="https://nordible.com/">nordible</a></footer>
</div>
<script>
  async function sendInstrumentsToWebSocket(instruments) {
        try {
          const response = await fetch('http://localhost:3000/start-websocket', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(instruments),
          });

          if (response.ok) {
            document.getElementById('responseMessage').innerText = 'WebSocket server started successfully';
            document.getElementById('responseMessage').className = 'alert alert-success';
            document.getElementById('startWebhook').style.display = 'none';
            document.getElementById('stopWebhook').style.display = 'block';
          } else {
            throw new Error('Failed to start WebSocket server');
          }

          const responseData = await response.json();
          console.log('Response:', responseData);
          // You can perform additional actions with the response if needed
        } catch (error) {
          document.getElementById('responseMessage').innerText = 'Failed to start WebSocket server';
          document.getElementById('responseMessage').className = 'alert alert-danger';
        }

        document.getElementById('responseMessage').style.display = 'block';
      }

  // Function to handle the click event for stopping the WebSocket
  document.getElementById('stopWebhook').addEventListener('click', async function () {
    try {
      const response = await fetch('http://localhost:3000/stop-websocket', {
        method: 'POST',
      });

      if (response.ok) {
        document.getElementById('responseMessage').innerText = 'WebSocket server stopped successfully';
        document.getElementById('responseMessage').className = 'alert alert-success';
      } else {
        throw new Error('Failed to stop WebSocket server');
      }
    } catch (error) {
      document.getElementById('responseMessage').innerText = 'Failed to stop WebSocket server';
      document.getElementById('responseMessage').className = 'alert alert-danger';
    }

    document.getElementById('responseMessage').style.display = 'block';
  });
  $(document).ready(function() {
    // Add instrument fieldset on button click
    $("#addInstrument").on("click", function() {
      var fieldset = `
        <div class="form-row mb-2 instrument-field">
          <input type="number" class="form-control" placeholder="Instrument Token" name="instrument_token[]" required>
          <input type="number" class="form-control" placeholder="Min Price" name="min_price[]" required>
          <input type="number" class="form-control" placeholder="Max Price" name="max_price[]" required>
        </div>
      `;
      $("#instrumentFields").append(fieldset);
    });

    // Form submission
    $("#instrumentForm").submit(function(event) {
      event.preventDefault();

      var formData = $(this).serializeArray();
      var instruments = [];

      for (var i = 0; i < formData.length; i += 3) {
        var instrumentObj = {
          instrument_token: parseInt(formData[i].value),
          min_price: parseFloat(formData[i + 1].value),
          max_price: parseFloat(formData[i + 2].value)
        };
        instruments.push(instrumentObj);
      }

      // Simulate API call (Replace this with actual API endpoint and HTTP request)
      console.log("Posting to API:", instruments);
      sendInstrumentsToWebSocket(instruments)
      // Reset form after submission
      $("#instrumentFields").empty();
      $("#instrumentForm")[0].reset();
    });
  });
</script>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-109226220-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-109226220-1');
</script>
</body>
</html>
